# load in yaml anchors for helmfiles `Release Template` feature
{{ $gitDir := (exec "git" (list "rev-parse" "--show-toplevel") | trim) }}
{{ readFile (printf "%s/helmfile/_helper/templates.yaml" $gitDir) }}

{{ $environment := requiredEnv "ENVIRONMENT" }}
{{ $baseDomain := requiredEnv "BASE_DOMAIN" }}

releases:
  - <<: *common_releases
    values:
      - values/common.yaml
      - global:
          domain:
            baseDomain: {{ $baseDomain }}
            subdomains:
              supabase: supabase-{{ $environment }}
              fsaiosapp: fsaios-{{ $environment }}
      - kong:
          ingress:
            annotations:
              external-dns.alpha.kubernetes.io/hostname: "supabase-{{ $environment }}.{{ $baseDomain }}"
              external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
            hosts:
              - host: "supabase-{{ $environment }}"
                paths:
                  - path: /
                    pathType: Prefix
            tls: []
  - <<: *common_namespace
    name: addon-components
    chart: ./components

