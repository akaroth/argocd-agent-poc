# load in yaml anchors for helmfiles `Release Template` feature
{{ $gitDir := (exec "git" (list "rev-parse" "--show-toplevel") | trim) }}
{{ readFile (printf "%s/helmfile/_helper/templates.yaml" $gitDir) }}
{{ $environment := requiredEnv "ENVIRONMENT" }}
{{ $baseDomain := requiredEnv "BASE_DOMAIN" }}
{{ $minioApiHost := printf "minio-api-%s.%s" $environment $baseDomain }}
{{ $minioConsoleHost := printf "minio-console-%s.%s" $environment $baseDomain }}

repositories:
  - name: minio
    url: https://operator.min.io/

releases:
  - <<: *common_releases
    values:
      - tenant:
          name: fsai-minio
          pools:
            - servers: 1
              name: pool-0
              volumesPerServer: 1
              size: 10Gi

      - ingress:
          api:
            enabled: true
            ingressClassName: nginx
            labels:
              check: argo-check
            annotations:
              external-dns.alpha.kubernetes.io/hostname: {{ $minioApiHost }}
              external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
              nginx.ingress.kubernetes.io/ssl-passthrough: "true"
              nginx.ingress.kubernetes.io/backend-protocol: https
              nginx.ingress.kubernetes.io/upstream-vhost: {{ $minioApiHost }}

            host: {{ $minioApiHost }}
            tls:
              - hosts:
                - {{ $minioApiHost }}

          console:
            enabled: true
            ingressClassName: nginx
            annotations:
              external-dns.alpha.kubernetes.io/hostname: {{ $minioConsoleHost }}
              external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
              nginx.ingress.kubernetes.io/ssl-passthrough: "true"
              nginx.ingress.kubernetes.io/backend-protocol: https
              nginx.ingress.kubernetes.io/upstream-vhost: {{ $minioConsoleHost }}
            host: {{ $minioConsoleHost }}
            tls:
              - hosts:
                - {{ $minioConsoleHost }}
